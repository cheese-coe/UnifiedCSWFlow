# UnifiedCSWFlow

This solution treats to automatize the process of generating physics-based probabilistic seismic hazard analisys (PSHA) models using CyberShake software platform (developed by SCEC) in Marenostrum IV cluster.

## How To

###  1- Load environment setup

```
source <UnifiedCSWFlow_Path>/env.sh
```

>**NOTE:** "UnifiedCSWFlow_Path" is the directory where the code is

###  2- Prepare an empty data base (only the if you haven't defined one yet)

```
cp <UnifiedCSWFlow_Path>/input/EmptyDBTemplate.sqlite <my_Workspace_path>/DB.sqlite
```

>**NOTE:** "my_Workspace_path" is a directory which user choose

###  3- Prepare the input parameters from a template

Copy the template to your workspace ...

```
cp <UnifiedCSWFlow_Path>/input/sitesInputTemplate.json  <my_Workspace_path>/input.json
```
... and modify it with the proper setup

```
vi <my_Workspace_path>/input.json
```

### 4- Run and wait for results

Running the workflow
```
cd <my_Workspace_path>
python  <UnifiedCSWFlow_Path>/main.py <my_Workspace_path>/input.json
```

Explore the results. Notice that a different directory will be generated per site.
output directories will have the form **<site_name>_<run_id>**


## Input definition

Input parameters are classified in 4 different groups: input, output and compute.

| Group   | Section    | Field  | Description | 
| ---     | ---        | ---    | --- |
| input   | region     |        | Study region (specified in table **Studies**)| 
| input   | sites      |        | List of sites to process (should match with the table **CyberShake_Sites**) | 
| input   | ERF        |  name   | ERF selection (table **ERF_IDs** in the database)     | 
| input   | model      |  name      | It corresponds to the model name in the table **Velocity_Models**. |
| input   | model      |  gridOut, box, coords, path      | Outputs in the California region PreCVM and UCVM stages. These were removed from the original workflow because they are specific for California and so, they have to be generated by hand| 
| input   | cyberShake |   path     | Path to CyberShake code base installation |
| input   | cyberShake |    gravesPitarka    | Graves-Pitarka version definition (only 3.3.1 and 5.4.2 are available) |
| input   | database   |  path      |  SQLite database path |
| input   | database   |  importFrom      |  ERF definition (directory where *csv are) |
| input   | database   |  populate      |  flag (true or false) for deciding if database should be populated with ERF definition |
| output  | path       |        | The path where all results and intermediate files are leaved
| compute | setup      |  focalMechanism, sourceFrequency, frequency, periods, spacing | It contains the parameters concerning the problem physics |
| compute | restart    |             | A restart mechanism. It allows to restart automatically the execution.|
| compute | workers    |             | Number of sites that will be simulated in parallel.|
| compute | resources  |   time, nodes, task-per-node, cpus-per-taskm qos  | Required computational resources, consider AWP requirements. For the remaining stages, resources are estimated from these. |
| compute | decomposition  |   x, y, z     | Domain decomposition for AWP simulation |


## Considerations

### Loading data to the SQLite Database

All information regarding the region ERF (EarthQuake Rupture Forecast) is imported
in runtime from a specific directory set on the input parameters file (JSON). So:

 * the directory should contain a file name per table in the database having that:
   - the name of the file should match the table (e.g. CyberShake_Runs.csv)
   - first line of the file contains a comma separated names of the table's fields
   - next lines contain the registries of the table, set as comma separated values
 * the parameter is "importFrom" and defines the path from where load the CSV
 * if you have an already populated database, you can disable this option ("populate")
 seting it to "false"
 
 >**NOTE:** MicroSoft Excel and Google Sheets has options to export data in the above format

## Disclaimer

> Authors:  Juan Esteban RodrÃ­guez, Josep de la Puente
> Contact: juan.rodriguez@bsc.es, josep.delapuente@bsc.es

> This program is based on the SCEC CyberShake workflow. The majority of the scripts
> generated by this code are based on the provided by Scott Callaghan in a prior
> effort in validating CyberShake in Marenostrum IV, a BSC cluster.

> This program is free software: you can redistribute it and/or modify
> it under the terms of the GNU General Public License as published by
> the Free Software Foundation, either version 3 of the License, or
> (at your option) any later version.

> This program is distributed in the hope that it will be useful,
> but WITHOUT ANY WARRANTY; without even the implied warranty of
> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
> GNU General Public License for more details.

> You should have received a copy of the GNU General Public License
> along with this program.  If not, see <https://www.gnu.org/licenses/>.
